# **Сервис сокращения ссылок**

Консольный сервис для создания коротких ссылок с поддержкой лимитов переходов, времени жизни ссылок (**TTL**) и мультипользовательского режима без авторизации.

---

## **Описание**

Сервис позволяет пользователям создавать короткие ссылки из длинных URL с возможностью:

- установки лимита переходов по ссылке;
- автоматической блокировки и удаления ссылки по истечении времени жизни (**TTL**);
- управления своими ссылками (редактирование лимита, удаление);
- изоляции данных между пользователями через **UUID**.

Проект реализован как **CLI-приложение** и разработан на основе реального технического задания компании **PROMO IT**.

---

## **Требования**

- **Java 17** или выше
- **Maven 3.8+** (или запуск из IDE, например IntelliJ IDEA)

---

## **Установка**

### **Проверка Java**

Убедитесь, что Java установлена:
```
java -version
```
Если Java не установлена, используйте OpenJDK или Oracle JDK.

---

### **Получение проекта**
```
git clone <repository-url>  
cd link-shortener
```
---

### **Установка зависимостей и сборка**

Проект использует **Maven**, все зависимости загружаются автоматически:
```
mvn clean package
```
---

## **Запуск**

### **Запуск из IDE**

Точка входа в приложение:
```
src/main/java/ru/promo/shortener/Application.java
```
Запустите класс **Application**.

---

### **Запуск из JAR**
```
mvn package  
java -jar target/link-shortener-1.0-SNAPSHOT.jar
```
---

## **Конфигурация**

Параметры приложения задаются в файле:
```
src/main/resources/application.properties
```
Пример конфигурации:
```
# ShortKey generation
shortkey.length.initial      = 6    # стартовая длина ключа
shortkey.length.max          = 10   # максимальная длина ключа
shortkey.attempts.per.length = 10   # попыток генерации на длину

# Link settings
link.ttl.seconds             = 3600 # время жизни ссылки (сек)
link.default.max-clicks      = 3    # лимит кликов по умолчанию

# Cleanup settings
cleanup.interval.seconds     = 60   # интервал очистки (сек)
```
**Важно:**  
Время жизни ссылки (**TTL**) задаётся системой и **не может изменяться пользователем**, что соответствует требованиям технического задания.

---

## **Пользователи и UUID**

Сервис работает **без авторизации**. Пользователь определяется по **UUID**.

Используемые файлы:
```
- **user.uuid** — UUID текущего пользователя
- **users.txt** — список всех созданных пользователей
```
Если файл **user.uuid** отсутствует, UUID генерируется автоматически при первом запуске.

В рамках одной сессии можно переключаться между пользователями.

---

## **Использование (CLI)**

После запуска приложения доступен интерактивный CLI.

---

### **Создание ссылки**

Создание ссылки с лимитом по умолчанию:
```
create <url>
```
Создание ссылки с пользовательским лимитом кликов:
```
create <url> <maxClicks>
```
Примеры:
```
create https://example.com  
create https://google.com 50
```
---

### **Переход по ссылке**
```
open <shortKey>
```
Если ссылка активна — открывается оригинальный URL в браузере.  
Если лимит кликов или TTL исчерпаны — ссылка становится недоступной.

---

### **Просмотр ссылок**

Список ссылок текущего пользователя:
```
list
```
Список всех ссылок в системе (debug / демонстрация мультипользовательского режима):
```
list-all
```
---

### **Управление ссылками**

Изменение лимита переходов (**доступно только владельцу**):
```
set-limit <shortKey> <newMaxClicks>
```
Если новый лимит меньше уже совершённых переходов, ссылка сразу помечается как истёкшая.

Удаление ссылки (**доступно только владельцу**):
```
delete <shortKey>
```
---

### **Управление пользователями**

Создание нового пользователя и переключение на него:
```
new-user
```
Переключение на существующего пользователя:
```
switch-user <uuid>
```
Показать текущего пользователя:
```
whoami
```
---

### **Завершение работы**
```
exit
```
---

## **Статусы ссылок**

- **ACTIVE** — ссылка доступна
- **EXPIRED_BY_CLICKS** — исчерпан лимит переходов
- **EXPIRED_BY_TTL** — истёк срок жизни
- **DELETED** — ссылка удалена владельцем

---

## **Валидация и безопасность**

- URL должен быть корректным и использовать **http** или **https**
- **shortKey** не может быть пустым и не должен содержать пробелы
- **maxClicks** должен быть положительным числом
- редактирование и удаление ссылок доступны **только владельцу**
- проверки прав доступа выполняются на уровне сервиса

Ошибки обрабатываются через доменные исключения с понятными сообщениями в CLI.

---

## **Архитектура проекта**

Проект реализован в соответствии с принципами **чистой архитектуры (Clean Architecture)** и разделён на логические слои. Такое разделение обеспечивает читаемость кода, изоляцию бизнес-логики, удобство тестирования и возможность дальнейшего расширения функциональности без затрагивания других частей системы.

### **Структура проекта**
```
src/main/java/ru/promo/shortener/  
├── core/  
│   ├── model/        — доменные модели  
│   ├── service/      — бизнес-логика и сервисы  
│   ├── user/         — идентификация пользователей  
│   └── exceptions/   — доменные исключения  
├── infra/  
│   ├── repository/  — реализации хранилищ данных  
│   ├── generator/   — генерация коротких ключей  
│   └── user/        — файловые реализации работы с пользователями  
├── cli/             — консольный интерфейс пользователя  
├── config/          — загрузка и хранение конфигурации  
└── Application.java — точка входа в приложение
```
---

## **Описание слоёв и компонентов**

### **Model Layer (core.model)**

Содержит доменные модели, не зависящие от инфраструктуры и пользовательского интерфейса.

- **ShortLink** — модель короткой ссылки

- **LinkStatus** — перечисление возможных состояний ссылки.

---

### **Repository Layer (core.service + infra)**

Отвечает за хранение и доступ к данным.

- **ShortLinkRepository** — интерфейс репозитория ссылок.

- **InMemoryShortLinkRepository** — in-memory реализация репозитория.  
  Использует `ConcurrentHashMap` для потокобезопасного хранения ссылок и поддержки мультипользовательского режима.

---

### **Service Layer (core.service)**

Содержит основную бизнес-логику приложения.

- **ShortLinkService** — основной сервис приложения.

- **ExpiredLinkCleaner** — фоновый сервис, который:
    - периодически проверяет ссылки;
    - определяет истёкшие по TTL или лимиту;
    - удаляет или помечает такие ссылки как недоступные.

---

### **User Layer (core.user + infra.user)**

Отвечает за идентификацию и управление пользователями.

- **UserIdentityProvider** — интерфейс провайдера пользователя.  
  Определяет получение UUID текущего пользователя.

- **FileUserIdentityProvider** — файловая реализация провайдера.

---

### **CLI Layer (cli)**

Отвечает за взаимодействие с пользователем через консоль.

- **ConsoleCli** - консольный интерфейс,

---

### **Config Layer (config)**

Отвечает за конфигурацию приложения.

- **ApplicationConfig** — объект конфигурации.

- **ApplicationConfigLoader** — компонент загрузки конфигурации из файла `application.properties`.

---

## **Принципы проектирования**

В проекте применяются следующие архитектурные и инженерные принципы:

- **Separation of Concerns** — чёткое разделение ответственности между слоями
- **Single Responsibility Principle** — каждый класс решает одну задачу
- **Dependency Injection** — зависимости передаются через конструкторы
- **SOLID (базовый уровень)**
- **Thread Safety** — использование потокобезопасных коллекций
- **Testability** — бизнес-логика изолирована и покрыта unit-тестами  

---

## **Тестирование**

Проект покрыт **unit- и интеграционными тестами** с использованием **JUnit 5**.  
Тестирование направлено на проверку корректности бизнес-логики, контроля доступа, работы с лимитами переходов, времени жизни ссылок (TTL) и мультипользовательского режима.

### **Запуск тестов**

Для запуска всех тестов используется Maven:
```
mvn test
```
Все тесты запускаются автоматически и не требуют дополнительной настройки окружения.

---

### **Покрываемые сценарии**

#### **ShortLinkServiceTest**

Тестируется основная бизнес-логика сервиса сокращения ссылок:

- валидация конфигурации приложения;
- создание коротких ссылок с валидными и невалидными URL;
- создание ссылок с пользовательским лимитом кликов;
- генерация уникальных коротких ключей (`shortKey`);
- обработка коллизий при генерации коротких ключей;
- корректный учёт переходов по ссылке;
- блокировка ссылки после достижения лимита переходов;
- блокировка ссылки по истечении времени жизни (TTL);
- редактирование лимита переходов владельцем ссылки;
- немедленная блокировка ссылки при уменьшении лимита ниже текущего количества кликов;
- контроль доступа (редактирование и удаление доступны только владельцу);
- удаление ссылок владельцем.

#### **InMemoryShortLinkRepositoryTest**

Тестируется слой хранения данных:

- сохранение ссылки в репозитории;
- получение ссылки по короткому ключу;
- получение списка ссылок владельца;
- удаление ссылки;
- корректная работа in-memory хранилища.

---

### **Типы тестов**

- **Unit-тесты** — проверка отдельных методов и бизнес-правил;
- **Интеграционные сценарии** — проверка совместной работы сервисного слоя и репозитория.

